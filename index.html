<!doctype HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <!-- Update to newer versions of A-Frame and AR.js -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <!-- Add ARJS-device-orientation for better iOS compatibility -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
  <script>
    // Modified hit-test component with better iOS support
    AFRAME.registerComponent('hit-test', {
      init: function () {
        const box = document.querySelector('#ar-box');
        box.setAttribute('visible', 'false');
        
        // Check if WebXR is available and supported
        if (navigator.xr) {
          console.log('WebXR is available');
        } else {
          console.log('WebXR not available - falling back to AR.js');
        }
        
        // Handle touch events for iOS
        document.addEventListener('touchstart', (event) => {
          // Prevent default behavior for touch events
          event.preventDefault();
          
          console.log('Touch event detected');
          
          // Get screen touch coordinates
          const touch = event.touches[0];
          const touchX = touch.clientX / window.innerWidth;
          const touchY = touch.clientY / window.innerHeight;
          
          console.log(`Touch coordinates: ${touchX}, ${touchY}`);
          
          // Try AR.js hit testing first
          const arjsSystem = this.el.sceneEl.systems['arjs'];
          if (arjsSystem && arjsSystem.hitTesting) {
            const hitPosition = arjsSystem.hitTesting.getHitPosition();
            if (hitPosition) {
              console.log('AR.js hit position found:', hitPosition);
              box.setAttribute('position', hitPosition);
              box.setAttribute('visible', 'true');
              return;
            }
          }
          
          // Fallback: project touch to a fixed distance if hit testing fails
          console.log('Using fallback positioning');
          const camera = document.querySelector('[camera]');
          if (camera) {
            // Create a position 2 meters in front of the camera
            // Adjust x and y based on touch position
            const xOffset = (touchX - 0.5) * 2; // -1 to 1 range
            const yOffset = (0.5 - touchY) * 2; // -1 to 1 range
            
            // Get camera direction
            const cameraRotation = camera.getAttribute('rotation');
            const radians = THREE.MathUtils.degToRad(cameraRotation.y);
            
            // Calculate position
            const x = Math.sin(radians) * 2 + xOffset;
            const z = -Math.cos(radians) * 2;
            
            box.setAttribute('position', {x: x, y: yOffset, z: z});
            box.setAttribute('visible', 'true');
          }
        });
        
        // Keep original event listeners for non-iOS devices
        this.el.addEventListener('ar-hit-test-start', () => {
          console.log('AR hit testing started');
        });
        
        this.el.addEventListener('ar-hit-test-achieved', (event) => {
          console.log('AR hit test achieved');
          const position = event.detail.position;
          box.setAttribute('position', position);
          box.setAttribute('visible', 'true');
        });
      }
    });
  </script>
  <!-- Add iOS-specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body style='margin: 0; overflow: hidden;'>
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; trackingMethod: best;"
    hit-test>
    
    <a-box id="ar-box" 
           rotation="0 45 0" 
           scale="0.5 0.5 0.5" 
           material="opacity: 0.8; color: #4CC3D9;"
           visible="false"></a-box>
    
    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>